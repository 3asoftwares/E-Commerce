name: Deploy Backend (Railway)

on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches: [main]

concurrency:
  group: deploy-railway-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  RAILWAY_ENABLED: 'true'

# ============================================================
# TEMPORARY: Only Auth Service deployment for testing
# ============================================================

jobs:
  # ===========================================
  # DEPLOY AUTH SERVICE
  # ===========================================
  deploy-auth:
    name: Deploy Auth Service
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Verify Railway Token
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "::error::RAILWAY_TOKEN secret is not set"
            exit 1
          fi
          echo "Railway token is configured"

      - name: Deploy to Railway
        working-directory: services/auth-service
        run: |
          railway link --project ${{ secrets.RAILWAY_PROJECT_ID }} --environment production
          railway up --service ${{ secrets.RAILWAY_SERVICE_AUTH }} --detach
          echo "### Auth Service Deployed" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # DEPLOYMENT SUMMARY
  # ===========================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-auth]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Railway Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-auth.result }}" == "success" ]; then
            echo "| Auth | ✅ deployed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-auth.result }}" == "failure" ]; then
            echo "| Auth | ❌ failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Auth | ⏭️ skipped |" >> $GITHUB_STEP_SUMMARY
          fi

# ============================================================
# COMMENTED OUT FOR TESTING - REVERT AFTER AUTH WORKS
# ============================================================
# deploy-category:
# deploy-coupon:
# deploy-gateway:
# deploy-order:
# deploy-product:
# deploy-ticket:
# ============================================================
