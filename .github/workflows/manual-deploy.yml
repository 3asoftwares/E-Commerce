# Manual Deployment Workflow for Team Members
name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        type: choice
        options:
          - staging
          - production
      app:
        description: 'Application to Deploy'
        required: true
        type: choice
        options:
          - admin-app
          - seller-app
          - shell-app
          - all-frontend
      reason:
        description: 'Reason for deployment'
        required: true
        type: string
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        type: boolean
        default: false

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID_ADMIN: ${{ secrets.VERCEL_PROJECT_ID_ADMIN }}
  VERCEL_PROJECT_ID_SELLER: ${{ secrets.VERCEL_PROJECT_ID_SELLER }}
  VERCEL_PROJECT_ID_SHELL: ${{ secrets.VERCEL_PROJECT_ID_SHELL }}

jobs:
  # ===========================================
  # VALIDATE & LOG DEPLOYMENT REQUEST
  # ===========================================
  validate:
    runs-on: ubuntu-latest
    outputs:
      approved: ${{ steps.validate.outputs.approved }}
    steps:
      - name: Log Deployment Request
        run: |
          echo "ðŸ“‹ =============================================="
          echo "ðŸ“‹ MANUAL DEPLOYMENT REQUEST"
          echo "ðŸ“‹ =============================================="
          echo "ðŸ“‹ Requested by: ${{ github.actor }}"
          echo "ðŸ“‹ Environment: ${{ github.event.inputs.environment }}"
          echo "ðŸ“‹ Application: ${{ github.event.inputs.app }}"
          echo "ðŸ“‹ Reason: ${{ github.event.inputs.reason }}"
          echo "ðŸ“‹ Skip Tests: ${{ github.event.inputs.skip_tests }}"
          echo "ðŸ“‹ Timestamp: $(date -u)"
          echo "ðŸ“‹ =============================================="

      - name: Validate Request
        id: validate
        run: |
          # Add any validation logic here
          if [ -z "${{ github.event.inputs.reason }}" ]; then
            echo "âŒ Deployment reason is required!"
            exit 1
          fi
          echo "approved=true" >> $GITHUB_OUTPUT

  # ===========================================
  # RUN TESTS (unless skipped)
  # ===========================================
  test:
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build packages
        run: |
          yarn workspace 3asoftwares/types build
          yarn workspace 3asoftwares/utils build

      - name: Run Tests
        run: |
          if [ "${{ github.event.inputs.app }}" == "admin-app" ] || [ "${{ github.event.inputs.app }}" == "all-frontend" ]; then
            yarn workspace 3asoftwares/admin-app test --passWithNoTests || true
          fi
          if [ "${{ github.event.inputs.app }}" == "seller-app" ] || [ "${{ github.event.inputs.app }}" == "all-frontend" ]; then
            yarn workspace 3asoftwares/seller-app test --passWithNoTests || true
          fi

  # ===========================================
  # DEPLOY ADMIN APP
  # ===========================================
  deploy-admin:
    runs-on: ubuntu-latest
    needs: [validate, test]
    if: |
      always() && 
      needs.validate.outputs.approved == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (github.event.inputs.app == 'admin-app' || github.event.inputs.app == 'all-frontend')
    environment: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        working-directory: apps/admin-app
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            vercel --prod --token=${{ secrets.VERCEL_TOKEN }}
          else
            vercel --token=${{ secrets.VERCEL_TOKEN }}
          fi
        env:
          VERCEL_PROJECT_ID: ${{ env.VERCEL_PROJECT_ID_ADMIN }}

      - name: Deployment Complete
        run: |
          echo "âœ… Admin App deployed to ${{ github.event.inputs.environment }}"

  # ===========================================
  # DEPLOY SELLER APP
  # ===========================================
  deploy-seller:
    runs-on: ubuntu-latest
    needs: [validate, test]
    if: |
      always() && 
      needs.validate.outputs.approved == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (github.event.inputs.app == 'seller-app' || github.event.inputs.app == 'all-frontend')
    environment: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        working-directory: apps/seller-app
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            vercel --prod --token=${{ secrets.VERCEL_TOKEN }}
          else
            vercel --token=${{ secrets.VERCEL_TOKEN }}
          fi
        env:
          VERCEL_PROJECT_ID: ${{ env.VERCEL_PROJECT_ID_SELLER }}

      - name: Deployment Complete
        run: |
          echo "âœ… Seller App deployed to ${{ github.event.inputs.environment }}"

  # ===========================================
  # DEPLOY SHELL APP
  # ===========================================
  deploy-shell:
    runs-on: ubuntu-latest
    needs: [validate, test]
    if: |
      always() && 
      needs.validate.outputs.approved == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (github.event.inputs.app == 'shell-app' || github.event.inputs.app == 'all-frontend')
    environment: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        working-directory: apps/shell-app
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            vercel --prod --token=${{ secrets.VERCEL_TOKEN }}
          else
            vercel --token=${{ secrets.VERCEL_TOKEN }}
          fi
        env:
          VERCEL_PROJECT_ID: ${{ env.VERCEL_PROJECT_ID_SHELL }}

      - name: Deployment Complete
        run: |
          echo "âœ… Shell App deployed to ${{ github.event.inputs.environment }}"

  # ===========================================
  # DEPLOYMENT SUMMARY
  # ===========================================
  summary:
    runs-on: ubuntu-latest
    needs: [deploy-admin, deploy-seller, deploy-shell]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "ðŸ“Š =============================================="
          echo "ðŸ“Š DEPLOYMENT SUMMARY"
          echo "ðŸ“Š =============================================="
          echo "ðŸ“Š Environment: ${{ github.event.inputs.environment }}"
          echo "ðŸ“Š Application: ${{ github.event.inputs.app }}"
          echo "ðŸ“Š Requested by: ${{ github.actor }}"
          echo "ðŸ“Š Reason: ${{ github.event.inputs.reason }}"
          echo "ðŸ“Š"
          echo "ðŸ“Š Results:"
          echo "ðŸ“Š   Admin App: ${{ needs.deploy-admin.result }}"
          echo "ðŸ“Š   Seller App: ${{ needs.deploy-seller.result }}"
          echo "ðŸ“Š   Shell App: ${{ needs.deploy-shell.result }}"
          echo "ðŸ“Š =============================================="
