name: Deploy Auth Service (Railway)

on:
  push:
    branches: [main]
    paths:
      - 'services/auth-service/**'
      - 'packages/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy (ignore change detection)'
        required: false
        type: boolean
        default: true

concurrency:
  group: deploy-auth-railway-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'

jobs:
  # ===========================================
  # DEPLOY AUTH SERVICE
  # ===========================================
  deploy-auth:
    name: Deploy Auth Service
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Debug Secrets
        run: |
          echo "=== DEBUG: Checking Secrets ==="
          echo "RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}"
          echo "RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}"
          echo "RAILWAY_SERVICE_AUTH: ${{ secrets.RAILWAY_SERVICE_AUTH }}"
          echo "=== Token length: ${#RAILWAY_TOKEN} ==="

      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Verify Railway Token
        run: |
          echo "RAILWAY_TOKEN value: $RAILWAY_TOKEN"
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "::error::RAILWAY_TOKEN is not set"
            exit 1
          fi
          echo "Railway token is configured"
          railway whoami

      - name: Link to Railway Project
        working-directory: services/auth-service
        run: |
          echo "Using Project ID: ${{ secrets.RAILWAY_PROJECT_ID }}"
          echo "Linking to Railway project..."
          railway link --project ${{ secrets.RAILWAY_PROJECT_ID }} --environment production
          echo "Successfully linked to Railway project"

      - name: Deploy to Railway
        working-directory: services/auth-service
        run: |
          echo "Using Service ID: ${{ secrets.RAILWAY_SERVICE_AUTH }}"
          echo "Deploying auth-service to Railway..."
          railway up --service ${{ secrets.RAILWAY_SERVICE_AUTH }} --detach
          echo "### âœ… Auth Service Deployed to Railway" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Summary
        run: |
          echo "## Auth Service Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Auth Service |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Production |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
