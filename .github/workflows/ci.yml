name: CI/CD Pipeline

on:
  # Run CI on ALL branches
  push:
    branches: ['**']  # All branches
  pull_request:
    branches: [main, develop]  # PRs targeting main or develop

env:
  NODE_VERSION: '20'

jobs:
  # ===========================================
  # DETECT CHANGES - Only build what changed
  # ===========================================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.changes.outputs.packages }}
      auth-service: ${{ steps.changes.outputs.auth-service }}
      product-service: ${{ steps.changes.outputs.product-service }}
      order-service: ${{ steps.changes.outputs.order-service }}
      category-service: ${{ steps.changes.outputs.category-service }}
      coupon-service: ${{ steps.changes.outputs.coupon-service }}
      graphql-gateway: ${{ steps.changes.outputs.graphql-gateway }}
      shell-app: ${{ steps.changes.outputs.shell-app }}
      admin-app: ${{ steps.changes.outputs.admin-app }}
      seller-app: ${{ steps.changes.outputs.seller-app }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            packages:
              - 'packages/**'
            auth-service:
              - 'services/auth-service/**'
              - 'packages/**'
            product-service:
              - 'services/product-service/**'
              - 'packages/**'
            order-service:
              - 'services/order-service/**'
              - 'packages/**'
            category-service:
              - 'services/category-service/**'
              - 'packages/**'
            coupon-service:
              - 'services/coupon-service/**'
              - 'packages/**'
            graphql-gateway:
              - 'services/graphql-gateway/**'
              - 'packages/**'
            shell-app:
              - 'apps/shell-app/**'
              - 'packages/**'
            admin-app:
              - 'apps/admin-app/**'
              - 'packages/**'
            seller-app:
              - 'apps/seller-app/**'
              - 'packages/**'

  # ===========================================
  # BUILD & TEST PACKAGES
  # ===========================================
  build-packages:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.packages == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build packages
        run: |
          yarn workspace 3asoftwares/types build
          yarn workspace 3asoftwares/utils build
          yarn workspace 3asoftwares/ui build:lib

      - name: Test packages
        run: |
          yarn workspace 3asoftwares/types test --passWithNoTests
          yarn workspace 3asoftwares/utils test --passWithNoTests
          yarn workspace 3asoftwares/ui test --passWithNoTests

  # ===========================================
  # TEST BACKEND SERVICES
  # ===========================================
  test-auth-service:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-packages]
    if: always() && needs.detect-changes.outputs.auth-service == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
      - run: yarn install --frozen-lockfile
      - name: Build shared packages
        run: |
          yarn workspace 3asoftwares/types build
          yarn workspace 3asoftwares/utils build
      - run: yarn workspace 3asoftwares/auth-service test --passWithNoTests

  test-product-service:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-packages]
    if: always() && needs.detect-changes.outputs.product-service == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
      - run: yarn install --frozen-lockfile
      - name: Build shared packages
        run: |
          yarn workspace 3asoftwares/types build
          yarn workspace 3asoftwares/utils build
      - run: yarn workspace 3asoftwares/product-service test --passWithNoTests

  test-order-service:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-packages]
    if: always() && needs.detect-changes.outputs.order-service == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
      - run: yarn install --frozen-lockfile
      - name: Build shared packages
        run: |
          yarn workspace 3asoftwares/types build
          yarn workspace 3asoftwares/utils build
      - run: yarn workspace 3asoftwares/order-service test --passWithNoTests

  test-category-service:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-packages]
    if: always() && needs.detect-changes.outputs.category-service == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
      - run: yarn install --frozen-lockfile
      - name: Build shared packages
        run: |
          yarn workspace 3asoftwares/types build
          yarn workspace 3asoftwares/utils build
      - run: yarn workspace 3asoftwares/category-service test --passWithNoTests

  test-coupon-service:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-packages]
    if: always() && needs.detect-changes.outputs.coupon-service == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
      - run: yarn install --frozen-lockfile
      - name: Build shared packages
        run: |
          yarn workspace 3asoftwares/types build
          yarn workspace 3asoftwares/utils build
      - run: yarn workspace 3asoftwares/coupon-service test --passWithNoTests

  # ===========================================
  # TEST FRONTEND APPS
  # ===========================================
  test-admin-app:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-packages]
    if: always() && needs.detect-changes.outputs.admin-app == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
      - run: yarn install --frozen-lockfile
      - name: Build shared packages
        run: |
          yarn workspace 3asoftwares/types build
          yarn workspace 3asoftwares/utils build
          yarn workspace 3asoftwares/ui build:lib
      - run: yarn workspace 3asoftwares/admin-app test --passWithNoTests

  test-seller-app:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-packages]
    if: always() && needs.detect-changes.outputs.seller-app == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
      - run: yarn install --frozen-lockfile
      - name: Build shared packages
        run: |
          yarn workspace 3asoftwares/types build
          yarn workspace 3asoftwares/utils build
          yarn workspace 3asoftwares/ui build:lib
      - run: yarn workspace 3asoftwares/seller-app test --passWithNoTests

  test-shell-app:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-packages]
    if: always() && needs.detect-changes.outputs.shell-app == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
      - run: yarn install --frozen-lockfile
      - name: Build shared packages
        run: |
          yarn workspace 3asoftwares/types build
          yarn workspace 3asoftwares/utils build
          yarn workspace 3asoftwares/ui build:lib
      - run: yarn workspace 3asoftwares/shell-app test --passWithNoTests

  # ===========================================
  # BUILD CHECK (ensures everything compiles)
  # ===========================================
  build-check:
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
      - run: yarn install --frozen-lockfile
      - name: TypeScript Check
        run: yarn tsc --noEmit || true
