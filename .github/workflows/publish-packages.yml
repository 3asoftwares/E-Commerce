# Publish Packages to npm
# Triggers on: CI workflow completion (success) on main branch, releases, manual dispatch
# Required secrets:
#   - NPM_TOKEN: npm access token with publish permissions

name: Publish Packages to npm

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to publish'
        required: true
        default: 'all'
        type: choice
        options:
          - types
          - utils
          - ui-library
          - all
      version_bump:
        description: 'Version bump type'
        required: false
        type: choice
        options:
          - none
          - patch
          - minor
          - major
        default: 'none'

env:
  NODE_VERSION: '20'

jobs:
  # ===========================================
  # CHECK IF CI PASSED
  # ===========================================
  check-ci:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
    steps:
      - name: Check CI status
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger, proceeding..."
            echo "should_publish=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "release" ]; then
            echo "Release trigger, proceeding..."
            echo "should_publish=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "CI passed with all checks, proceeding with publish..."
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "CI did not pass (conclusion: ${{ github.event.workflow_run.conclusion }}), skipping publish..."
            echo "should_publish=false" >> $GITHUB_OUTPUT
          fi

  # ===========================================
  # VALIDATE SECRETS
  # ===========================================
  validate-secrets:
    needs: check-ci
    if: needs.check-ci.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Validate npm token
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "::error::NPM_TOKEN secret is not set"
            exit 1
          fi
          echo "âœ… NPM_TOKEN is configured"

  # ===========================================
  # PUBLISH @3asoftwares/types
  # ===========================================
  publish-types:
    needs: [check-ci, validate-secrets]
    runs-on: ubuntu-latest
    if: |
      needs.check-ci.outputs.should_publish == 'true' &&
      (github.event_name == 'workflow_run' || github.event_name == 'release' ||
       (github.event_name == 'workflow_dispatch' && (github.event.inputs.package == 'types' || github.event.inputs.package == 'all')))
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies from root
        run: yarn install --frozen-lockfile || yarn install

      - name: Build types package
        run: yarn build:types

      - name: Run tests
        run: yarn workspace @3asoftwares/types run test:coverage

      - name: Bump version (if specified)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.version_bump != 'none'
        working-directory: packages/types
        run: npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version

      - name: Check if version exists
        id: check-version
        working-directory: packages/types
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null; then
            echo "Version $PACKAGE_VERSION already exists on npm"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Version $PACKAGE_VERSION is new"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: steps.check-version.outputs.exists != 'true'
        working-directory: packages/types
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Summary
        run: |
          if [ "${{ steps.check-version.outputs.exists }}" == "true" ]; then
            echo "### â­ï¸ Types Package Skipped (version exists)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“¦ Types Package Published" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================
  # PUBLISH @3asoftwares/utils
  # ===========================================
  publish-utils:
    needs: [check-ci, validate-secrets, publish-types]
    runs-on: ubuntu-latest
    if: |
      always() && needs.validate-secrets.result == 'success' &&
      needs.check-ci.outputs.should_publish == 'true' &&
      (github.event_name == 'workflow_run' || github.event_name == 'release' ||
       (github.event_name == 'workflow_dispatch' && (github.event.inputs.package == 'utils' || github.event.inputs.package == 'all')))
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies from root
        run: yarn install --frozen-lockfile || yarn install

      - name: Build utils package
        run: yarn build:types && yarn build:utils

      - name: Run tests
        run: yarn workspace @3asoftwares/utils run test:coverage

      - name: Bump version (if specified)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.version_bump != 'none'
        working-directory: packages/utils
        run: npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version

      - name: Check if version exists
        id: check-version
        working-directory: packages/utils
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null; then
            echo "Version $PACKAGE_VERSION already exists on npm"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Version $PACKAGE_VERSION is new"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: steps.check-version.outputs.exists != 'true'
        working-directory: packages/utils
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Summary
        run: |
          if [ "${{ steps.check-version.outputs.exists }}" == "true" ]; then
            echo "### â­ï¸ Utils Package Skipped (version exists)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“¦ Utils Package Published" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================
  # PUBLISH @3asoftwares/ui
  # ===========================================
  publish-ui-library:
    needs: [check-ci, validate-secrets, publish-utils]
    runs-on: ubuntu-latest
    if: |
      always() && needs.validate-secrets.result == 'success' &&
      needs.check-ci.outputs.should_publish == 'true' &&
      (github.event_name == 'workflow_run' || github.event_name == 'release' ||
       (github.event_name == 'workflow_dispatch' && (github.event.inputs.package == 'ui-library' || github.event.inputs.package == 'all')))
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies from root
        run: yarn install --frozen-lockfile || yarn install

      - name: Build ui-library package
        run: |
          yarn build:types
          yarn build:utils
          yarn build:storybook

      - name: Run tests
        run: yarn workspace @3asoftwares/ui run test run

      - name: Bump version (if specified)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.version_bump != 'none'
        working-directory: packages/ui-library
        run: npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version

      - name: Check if version exists
        id: check-version
        working-directory: packages/ui-library
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null; then
            echo "Version $PACKAGE_VERSION already exists on npm"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Version $PACKAGE_VERSION is new"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: steps.check-version.outputs.exists != 'true'
        working-directory: packages/ui-library
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Summary
        run: |
          if [ "${{ steps.check-version.outputs.exists }}" == "true" ]; then
            echo "### â­ï¸ UI Library Package Skipped (version exists)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“¦ UI Library Package Published" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================
  # PUBLISH SKIPPED
  # ===========================================
  skip-notification:
    needs: check-ci
    if: needs.check-ci.outputs.should_publish == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Publish Skipped
        run: |
          echo "## â­ï¸ npm Publish Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "CI workflow did not pass all checks." >> $GITHUB_STEP_SUMMARY
          echo "Fix the failing checks and push again." >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # PUBLISH SUMMARY
  # ===========================================
  summary:
    needs: [check-ci, publish-types, publish-utils, publish-ui-library]
    if: always() && needs.check-ci.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Publish Summary
        run: |
          echo "## ðŸ“Š npm Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| @3asoftwares/types | ${{ needs.publish-types.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @3asoftwares/utils | ${{ needs.publish-utils.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @3asoftwares/ui | ${{ needs.publish-ui-library.result }} |" >> $GITHUB_STEP_SUMMARY
